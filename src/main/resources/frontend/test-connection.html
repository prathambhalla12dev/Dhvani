<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dhvani Connection Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #667eea;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #667eea;
            background: #f9f9f9;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            opacity: 0.9;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .status.red { background: #ef4444; }
        .status.green { background: #10b981; }
        .status.yellow { background: #f59e0b; }
    </style>
</head>
<body>
<div class="container">
    <h1>üéµ Dhvani Backend Connection Test</h1>

    <div class="test-section">
        <h3><span class="status red" id="status1"></span>Test 1: Backend Reachability</h3>
        <p>Checks if backend is running on port 8080</p>
        <button onclick="testBackendReachable()">Test Connection</button>
        <div id="result1" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h3><span class="status red" id="status2"></span>Test 2: CORS Configuration</h3>
        <p>Verifies CORS headers are properly configured</p>
        <button onclick="testCORS()">Test CORS</button>
        <div id="result2" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h3><span class="status red" id="status3"></span>Test 3: User Signup</h3>
        <p>Tests the signup endpoint</p>
        <input type="text" id="testUsername" placeholder="Username (e.g., testuser123)" value="testuser123">
        <input type="password" id="testPassword" placeholder="Password" value="password123">
        <button onclick="testSignup()">Test Signup</button>
        <div id="result3" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h3><span class="status red" id="status4"></span>Test 4: User Login</h3>
        <p>Tests the login endpoint</p>
        <button onclick="testLogin()">Test Login</button>
        <div id="result4" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h3><span class="status red" id="status5"></span>Test 5: Protected Endpoint</h3>
        <p>Tests accessing a protected endpoint with JWT token</p>
        <button onclick="testProtectedEndpoint()">Test Protected Route</button>
        <div id="result5" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h3>Run All Tests</h3>
        <button onclick="runAllTests()">Run All Tests Sequentially</button>
    </div>
</div>

<script>
    const API_BASE = 'http://localhost:8080/dhvani';
    let authToken = null;

    function showResult(testNum, message, isSuccess) {
        const resultDiv = document.getElementById(`result${testNum}`);
        const statusDiv = document.getElementById(`status${testNum}`);
        resultDiv.style.display = 'block';
        resultDiv.className = `result ${isSuccess ? 'success' : 'error'}`;
        resultDiv.innerHTML = message;
        statusDiv.className = `status ${isSuccess ? 'green' : 'red'}`;
    }

    function showInfo(testNum, message) {
        const resultDiv = document.getElementById(`result${testNum}`);
        resultDiv.style.display = 'block';
        resultDiv.className = 'result info';
        resultDiv.innerHTML = message;
        document.getElementById(`status${testNum}`).className = 'status yellow';
    }

    async function testBackendReachable() {
        showInfo(1, 'Testing connection...');
        try {
            const response = await fetch(`${API_BASE}/user/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: 'test', password: 'test' })
            });

            const data = await response.json();
            showResult(1,
                `‚úÖ Backend is reachable!\n` +
                `Status: ${response.status}\n` +
                `Response: ${JSON.stringify(data, null, 2)}`,
                true
            );
        } catch (error) {
            showResult(1,
                `‚ùå Cannot reach backend!\n` +
                `Error: ${error.message}\n\n` +
                `Make sure:\n` +
                `1. Backend is running: ./mvnw spring-boot:run\n` +
                `2. Backend is on port 8080\n` +
                `3. No firewall blocking the connection`,
                false
            );
        }
    }

    async function testCORS() {
        showInfo(2, 'Testing CORS...');
        try {
            const response = await fetch(`${API_BASE}/user/login`, {
                method: 'OPTIONS',
                headers: {
                    'Origin': window.location.origin,
                    'Access-Control-Request-Method': 'POST',
                    'Access-Control-Request-Headers': 'Content-Type'
                }
            });

            const corsHeaders = {
                'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers'),
                'Access-Control-Allow-Credentials': response.headers.get('Access-Control-Allow-Credentials')
            };

            const isSuccess = corsHeaders['Access-Control-Allow-Origin'] !== null;

            showResult(2,
                `${isSuccess ? '‚úÖ' : '‚ùå'} CORS Headers:\n` +
                JSON.stringify(corsHeaders, null, 2),
                isSuccess
            );
        } catch (error) {
            showResult(2, `‚ùå CORS test failed: ${error.message}`, false);
        }
    }

    async function testSignup() {
        showInfo(3, 'Testing signup...');
        const username = document.getElementById('testUsername').value;
        const password = document.getElementById('testPassword').value;

        const signupData = {
            username: username,
            fullName: "Test User",
            phoneNumber: "+91 9876543210",
            dateOfBirth: "2000-01-01",
            gender: "MALE",
            country: "INDIA",
            password: password,
            confirmPassword: password
        };

        try {
            const response = await fetch(`${API_BASE}/user/signup`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(signupData)
            });

            const data = await response.json();
            const isSuccess = data.status === 'SUCCESS';

            showResult(3,
                `${isSuccess ? '‚úÖ' : '‚ö†Ô∏è'} Signup Response:\n` +
                `Status: ${response.status}\n` +
                `Message: ${data.message}\n` +
                `Data: ${JSON.stringify(data, null, 2)}\n\n` +
                `${!isSuccess && data.message.includes('already exists') ? 'User already exists - this is OK for testing!' : ''}`,
                isSuccess || data.message.includes('already exists')
            );
        } catch (error) {
            showResult(3, `‚ùå Signup failed: ${error.message}`, false);
        }
    }

    async function testLogin() {
        showInfo(4, 'Testing login...');
        const username = document.getElementById('testUsername').value;
        const password = document.getElementById('testPassword').value;

        try {
            const response = await fetch(`${API_BASE}/user/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            const data = await response.json();
            const isSuccess = data.status === 'SUCCESS';

            if (isSuccess && data.data && data.data.token) {
                authToken = data.data.token;
            }

            showResult(4,
                `${isSuccess ? '‚úÖ' : '‚ùå'} Login Response:\n` +
                `Status: ${response.status}\n` +
                `Message: ${data.message}\n` +
                `Token received: ${authToken ? 'Yes' : 'No'}\n` +
                `Token: ${authToken ? authToken.substring(0, 20) + '...' : 'N/A'}`,
                isSuccess
            );
        } catch (error) {
            showResult(4, `‚ùå Login failed: ${error.message}`, false);
        }
    }

    async function testProtectedEndpoint() {
        showInfo(5, 'Testing protected endpoint...');

        if (!authToken) {
            showResult(5, '‚ö†Ô∏è No auth token available. Please run Test 4 (Login) first.', false);
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/song`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();
            const isSuccess = response.status === 200;

            showResult(5,
                `${isSuccess ? '‚úÖ' : '‚ùå'} Protected Endpoint Response:\n` +
                `Status: ${response.status}\n` +
                `Message: ${data.message}\n` +
                `Songs count: ${data.data ? data.data.length : 0}\n` +
                `Data: ${JSON.stringify(data, null, 2)}`,
                isSuccess
            );
        } catch (error) {
            showResult(5, `‚ùå Protected endpoint test failed: ${error.message}`, false);
        }
    }

    async function runAllTests() {
        await testBackendReachable();
        await new Promise(resolve => setTimeout(resolve, 1000));

        await testCORS();
        await new Promise(resolve => setTimeout(resolve, 1000));

        await testSignup();
        await new Promise(resolve => setTimeout(resolve, 1000));

        await testLogin();
        await new Promise(resolve => setTimeout(resolve, 1000));

        await testProtectedEndpoint();
    }
</script>
</body>
</html>