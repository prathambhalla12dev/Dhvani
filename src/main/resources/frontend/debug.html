<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dhvani Debug Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #4ec9b0;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .section {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section h2 {
            color: #569cd6;
            font-size: 18px;
            margin-bottom: 15px;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 5px 5px 0;
            font-size: 14px;
        }
        button:hover { background: #1177bb; }
        button:disabled {
            background: #3e3e42;
            cursor: not-allowed;
        }
        .output {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            font-size: 13px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .warning { color: #dcdcaa; }
        .info { color: #569cd6; }
        input, select {
            background: #3c3c3c;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            padding: 8px 12px;
            border-radius: 4px;
            width: 100%;
            margin: 5px 0;
            font-size: 14px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #9cdcfe;
            font-size: 13px;
        }
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-dot.red { background: #f48771; }
        .status-dot.green { background: #4ec9b0; }
        .status-dot.yellow { background: #dcdcaa; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .command {
            background: #1e1e1e;
            border-left: 3px solid #0e639c;
            padding: 10px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üîç Dhvani Connection Debugger</h1>

    <!-- System Check -->
    <div class="section">
        <h2>1. System Environment Check</h2>
        <button onclick="checkEnvironment()">Check System</button>
        <div id="env-output" class="output" style="display:none;"></div>
    </div>

    <!-- Backend Connection -->
    <div class="section">
        <h2>2. Backend Connection Test</h2>
        <div class="form-group">
            <label>Backend URL:</label>
            <input type="text" id="backend-url" value="http://localhost:8080/dhvani">
        </div>
        <button onclick="testBackendConnection()">Test Connection</button>
        <button onclick="testBackendHealth()">Check Health</button>
        <div id="backend-output" class="output" style="display:none;"></div>
    </div>

    <!-- CORS Test -->
    <div class="section">
        <h2>3. CORS Configuration Test</h2>
        <button onclick="testCORSDetailed()">Test CORS</button>
        <div id="cors-output" class="output" style="display:none;"></div>
    </div>

    <!-- Authentication Test -->
    <div class="section">
        <h2>4. Authentication Flow Test</h2>
        <div class="grid">
            <div>
                <div class="form-group">
                    <label>Username:</label>
                    <input type="text" id="test-username" value="debuguser">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="test-password" value="Debug123!">
                </div>
            </div>
            <div>
                <div class="form-group">
                    <label>Full Name:</label>
                    <input type="text" id="test-fullname" value="Debug User">
                </div>
                <div class="form-group">
                    <label>Phone:</label>
                    <input type="text" id="test-phone" value="+91 9999999999">
                </div>
            </div>
        </div>
        <button onclick="testSignup()">Test Signup</button>
        <button onclick="testLogin()">Test Login</button>
        <button onclick="testProtected()" id="test-protected-btn" disabled>Test Protected Endpoint</button>
        <div id="auth-output" class="output" style="display:none;"></div>
    </div>

    <!-- Network Inspector -->
    <div class="section">
        <h2>5. Network Request Inspector</h2>
        <button onclick="inspectNetworkRequest()">Inspect Sample Request</button>
        <div id="network-output" class="output" style="display:none;"></div>
    </div>

    <!-- Backend Logs Helper -->
    <div class="section">
        <h2>6. Backend Setup Verification</h2>
        <div id="setup-output" class="output">
            <div class="info">Run these commands in your terminal:</div>
            <div class="command">
                # 1. Check if backend is running<br>
                curl http://localhost:8080/dhvani/user/login
            </div>
            <div class="command">
                # 2. Check PostgreSQL connection<br>
                psql -U Pratham -d Dhvani -c "SELECT 1;"
            </div>
            <div class="command">
                # 3. View backend logs<br>
                ./mvnw spring-boot:run | grep -i "error\|exception\|dhvani"
            </div>
            <div class="command">
                # 4. Check what's using port 8080<br>
                # Mac/Linux:<br>
                lsof -i :8080<br>
                # Windows:<br>
                netstat -ano | findstr :8080
            </div>
        </div>
    </div>

    <!-- Full Diagnostic -->
    <div class="section">
        <h2>7. Run Complete Diagnostic</h2>
        <button onclick="runFullDiagnostic()">Run All Tests</button>
        <button onclick="clearAllOutputs()">Clear All</button>
    </div>
</div>

<script>
    let globalToken = null;
    let testResults = {
        environment: false,
        backend: false,
        cors: false,
        auth: false
    };

    function log(elementId, message, type = 'info') {
        const element = document.getElementById(elementId);
        element.style.display = 'block';
        const timestamp = new Date().toLocaleTimeString();
        const colorClass = type;
        element.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
        element.scrollTop = element.scrollHeight;
    }

    function clearLog(elementId) {
        const element = document.getElementById(elementId);
        element.innerHTML = '';
        element.style.display = 'none';
    }

    function checkEnvironment() {
        clearLog('env-output');
        log('env-output', '=== Environment Check ===', 'info');

        // Browser info
        log('env-output', `Browser: ${navigator.userAgent}`, 'info');
        log('env-output', `Page URL: ${window.location.href}`, 'info');
        log('env-output', `Protocol: ${window.location.protocol}`, 'info');
        log('env-output', `Origin: ${window.location.origin}`, 'info');

        // Check for conflicting libraries
        log('env-output', '\n=== Library Check ===', 'info');
        log('env-output', `jQuery: ${typeof $ !== 'undefined' ? 'Loaded' : 'Not loaded'}`,
            typeof $ !== 'undefined' ? 'warning' : 'success');
        log('env-output', `Axios: ${typeof axios !== 'undefined' ? 'Loaded' : 'Not loaded'}`, 'info');

        // Check fetch support
        log('env-output', '\n=== API Support ===', 'info');
        log('env-output', `Fetch API: ${typeof fetch !== 'undefined' ? '‚úì Supported' : '‚úó Not supported'}`,
            typeof fetch !== 'undefined' ? 'success' : 'error');
        log('env-output', `Promise: ${typeof Promise !== 'undefined' ? '‚úì Supported' : '‚úó Not supported'}`,
            typeof Promise !== 'undefined' ? 'success' : 'error');
        log('env-output', `Async/Await: Supported`, 'success');

        // Check console
        log('env-output', '\n=== Console Check ===', 'info');
        log('env-output', 'Open browser console (F12) to see network requests', 'warning');

        testResults.environment = true;
        log('env-output', '\n‚úì Environment check complete', 'success');
    }

    async function testBackendConnection() {
        clearLog('backend-output');
        const baseUrl = document.getElementById('backend-url').value;
        log('backend-output', `Testing connection to: ${baseUrl}`, 'info');

        try {
            log('backend-output', 'Attempting simple POST request...', 'info');
            const startTime = Date.now();

            const response = await fetch(`${baseUrl}/user/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: 'test',
                    password: 'test'
                })
            });

            const endTime = Date.now();
            const responseTime = endTime - startTime;

            log('backend-output', `‚úì Backend responded in ${responseTime}ms`, 'success');
            log('backend-output', `Status: ${response.status} ${response.statusText}`, 'info');
            log('backend-output', `Headers:`, 'info');

            response.headers.forEach((value, key) => {
                log('backend-output', `  ${key}: ${value}`, 'info');
            });

            const data = await response.json();
            log('backend-output', `\nResponse Body:`, 'info');
            log('backend-output', JSON.stringify(data, null, 2), 'info');

            testResults.backend = true;
            log('backend-output', '\n‚úì Backend is reachable and responding', 'success');

        } catch (error) {
            testResults.backend = false;
            log('backend-output', `‚úó Connection failed: ${error.message}`, 'error');
            log('backend-output', '\nPossible causes:', 'warning');
            log('backend-output', '1. Backend is not running', 'warning');
            log('backend-output', '2. Backend is running on different port', 'warning');
            log('backend-output', '3. Firewall blocking connection', 'warning');
            log('backend-output', '4. Backend crashed - check terminal logs', 'warning');
            log('backend-output', '\nTo fix:', 'info');
            log('backend-output', '‚Ä¢ Run: ./mvnw spring-boot:run', 'info');
            log('backend-output', '‚Ä¢ Check terminal for error messages', 'info');
            log('backend-output', '‚Ä¢ Verify PostgreSQL is running', 'info');
        }
    }

    async function testBackendHealth() {
        clearLog('backend-output');
        const baseUrl = document.getElementById('backend-url').value;

        const endpoints = [
            { url: '/user/login', method: 'POST', body: {username: 'test', password: 'test'} },
            { url: '/user/signup', method: 'POST', body: {} },
            { url: '/song', method: 'GET', requiresAuth: true }
        ];

        log('backend-output', '=== Testing Multiple Endpoints ===\n', 'info');

        for (const endpoint of endpoints) {
            try {
                log('backend-output', `Testing: ${endpoint.method} ${endpoint.url}`, 'info');

                const options = {
                    method: endpoint.method,
                    headers: { 'Content-Type': 'application/json' }
                };

                if (endpoint.method === 'POST') {
                    options.body = JSON.stringify(endpoint.body);
                }

                if (endpoint.requiresAuth && globalToken) {
                    options.headers['Authorization'] = `Bearer ${globalToken}`;
                }

                const response = await fetch(`${baseUrl}${endpoint.url}`, options);
                log('backend-output', `  Status: ${response.status}`,
                    response.status < 400 ? 'success' : 'warning');

            } catch (error) {
                log('backend-output', `  Error: ${error.message}`, 'error');
            }
            log('backend-output', '', 'info');
        }
    }

    async function testCORSDetailed() {
        clearLog('cors-output');
        const baseUrl = document.getElementById('backend-url').value;
        log('cors-output', '=== CORS Configuration Test ===\n', 'info');

        log('cors-output', `Current Origin: ${window.location.origin}`, 'info');
        log('cors-output', `Testing against: ${baseUrl}\n`, 'info');

        try {
            // Test OPTIONS preflight
            log('cors-output', 'Testing OPTIONS (preflight) request...', 'info');
            const optionsResponse = await fetch(`${baseUrl}/user/login`, {
                method: 'OPTIONS',
                headers: {
                    'Origin': window.location.origin,
                    'Access-Control-Request-Method': 'POST',
                    'Access-Control-Request-Headers': 'Content-Type,Authorization'
                }
            });

            log('cors-output', `OPTIONS Status: ${optionsResponse.status}`, 'info');

            const corsHeaders = {
                'access-control-allow-origin': optionsResponse.headers.get('access-control-allow-origin'),
                'access-control-allow-methods': optionsResponse.headers.get('access-control-allow-methods'),
                'access-control-allow-headers': optionsResponse.headers.get('access-control-allow-headers'),
                'access-control-allow-credentials': optionsResponse.headers.get('access-control-allow-credentials'),
                'access-control-max-age': optionsResponse.headers.get('access-control-max-age')
            };

            log('cors-output', '\nCORS Headers:', 'info');
            log('cors-output', JSON.stringify(corsHeaders, null, 2), 'info');

            // Check if our origin is allowed
            const allowedOrigin = corsHeaders['access-control-allow-origin'];
            if (allowedOrigin === window.location.origin || allowedOrigin === '*') {
                log('cors-output', '\n‚úì Origin is allowed', 'success');
                testResults.cors = true;
            } else {
                log('cors-output', `\n‚úó Origin not allowed. Allowed: ${allowedOrigin}`, 'error');
                log('cors-output', `Your origin: ${window.location.origin}`, 'warning');
                log('cors-output', '\nAdd this to SpringConfig.java allowedOrigins:', 'info');
                log('cors-output', `"${window.location.origin}"`, 'warning');
                testResults.cors = false;
            }

            // Test actual request
            log('cors-output', '\nTesting actual POST request...', 'info');
            const postResponse = await fetch(`${baseUrl}/user/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: 'test', password: 'test' })
            });

            log('cors-output', `POST Status: ${postResponse.status}`, 'success');
            log('cors-output', '‚úì CORS is working for POST requests', 'success');

        } catch (error) {
            testResults.cors = false;
            log('cors-output', `\n‚úó CORS Error: ${error.message}`, 'error');
            log('cors-output', '\nThis usually means:', 'warning');
            log('cors-output', '‚Ä¢ Backend CORS not configured for your origin', 'warning');
            log('cors-output', '‚Ä¢ Backend not running', 'warning');
            log('cors-output', '‚Ä¢ Network issue', 'warning');
        }
    }

    async function testSignup() {
        clearLog('auth-output');
        const baseUrl = document.getElementById('backend-url').value;
        const username = document.getElementById('test-username').value;
        const password = document.getElementById('test-password').value;
        const fullName = document.getElementById('test-fullname').value;
        const phone = document.getElementById('test-phone').value;

        log('auth-output', '=== Testing Signup ===\n', 'info');

        const signupData = {
            username: username,
            fullName: fullName,
            phoneNumber: phone,
            dateOfBirth: "2000-01-01",
            gender: "MALE",
            country: "INDIA",
            password: password,
            confirmPassword: password
        };

        log('auth-output', 'Signup payload:', 'info');
        log('auth-output', JSON.stringify(signupData, null, 2), 'info');

        try {
            const response = await fetch(`${baseUrl}/user/signup`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(signupData)
            });

            const data = await response.json();

            log('auth-output', `\nStatus: ${response.status}`, 'info');
            log('auth-output', 'Response:', 'info');
            log('auth-output', JSON.stringify(data, null, 2), 'info');

            if (data.status === 'SUCCESS') {
                log('auth-output', '\n‚úì Signup successful!', 'success');
            } else if (data.message && data.message.includes('already exists')) {
                log('auth-output', '\n‚ö† User already exists (this is OK for testing)', 'warning');
            } else {
                log('auth-output', `\n‚úó Signup failed: ${data.message}`, 'error');
            }

        } catch (error) {
            log('auth-output', `\n‚úó Signup error: ${error.message}`, 'error');
        }
    }

    async function testLogin() {
        clearLog('auth-output');
        const baseUrl = document.getElementById('backend-url').value;
        const username = document.getElementById('test-username').value;
        const password = document.getElementById('test-password').value;

        log('auth-output', '=== Testing Login ===\n', 'info');
        log('auth-output', `Username: ${username}`, 'info');
        log('auth-output', `Password: ${password}\n`, 'info');

        try {
            const response = await fetch(`${baseUrl}/user/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            const data = await response.json();

            log('auth-output', `Status: ${response.status}`, 'info');
            log('auth-output', 'Response:', 'info');
            log('auth-output', JSON.stringify(data, null, 2), 'info');

            if (data.status === 'SUCCESS' && data.data && data.data.token) {
                globalToken = data.data.token;
                document.getElementById('test-protected-btn').disabled = false;
                log('auth-output', '\n‚úì Login successful!', 'success');
                log('auth-output', `Token: ${globalToken.substring(0, 30)}...`, 'success');
                testResults.auth = true;
            } else {
                log('auth-output', `\n‚úó Login failed: ${data.message}`, 'error');
                log('auth-output', 'Try running signup first', 'warning');
                testResults.auth = false;
            }

        } catch (error) {
            testResults.auth = false;
            log('auth-output', `\n‚úó Login error: ${error.message}`, 'error');
        }
    }

    async function testProtected() {
        clearLog('auth-output');
        const baseUrl = document.getElementById('backend-url').value;

        if (!globalToken) {
            log('auth-output', '‚úó No token available. Please login first.', 'error');
            return;
        }

        log('auth-output', '=== Testing Protected Endpoint ===\n', 'info');
        log('auth-output', `Token: ${globalToken.substring(0, 30)}...\n`, 'info');

        try {
            const response = await fetch(`${baseUrl}/song`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${globalToken}`,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            log('auth-output', `Status: ${response.status}`, 'info');
            log('auth-output', 'Response:', 'info');
            log('auth-output', JSON.stringify(data, null, 2), 'info');

            if (response.status === 200) {
                log('auth-output', '\n‚úì Protected endpoint accessible!', 'success');
                log('auth-output', `Songs found: ${data.data ? data.data.length : 0}`, 'success');
            } else {
                log('auth-output', `\n‚úó Access denied: ${data.message}`, 'error');
            }

        } catch (error) {
            log('auth-output', `\n‚úó Error: ${error.message}`, 'error');
        }
    }

    async function inspectNetworkRequest() {
        clearLog('network-output');
        log('network-output', '=== Network Request Inspector ===\n', 'info');
        log('network-output', 'Open browser DevTools (F12) > Network tab', 'warning');
        log('network-output', 'Then watch the request being made...\n', 'warning');

        const baseUrl = document.getElementById('backend-url').value;

        try {
            log('network-output', 'Request Details:', 'info');
            log('network-output', `URL: ${baseUrl}/user/login`, 'info');
            log('network-output', `Method: POST`, 'info');
            log('network-output', `Headers: Content-Type: application/json`, 'info');
            log('network-output', `Body: {"username":"test","password":"test"}\n`, 'info');

            log('network-output', 'Making request...', 'info');

            const response = await fetch(`${baseUrl}/user/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: 'test', password: 'test' })
            });

            log('network-output', '\nResponse Details:', 'info');
            log('network-output', `Status: ${response.status} ${response.statusText}`, 'info');
            log('network-output', `Type: ${response.type}`, 'info');
            log('network-output', `URL: ${response.url}`, 'info');

            log('network-output', '\nResponse Headers:', 'info');
            response.headers.forEach((value, key) => {
                log('network-output', `  ${key}: ${value}`, 'info');
            });

            const data = await response.json();
            log('network-output', '\nResponse Body:', 'info');
            log('network-output', JSON.stringify(data, null, 2), 'success');

        } catch (error) {
            log('network-output', `\n‚úó Request failed: ${error.message}`, 'error');
            log('network-output', '\nCheck DevTools Console and Network tab for details', 'warning');
        }
    }

    async function runFullDiagnostic() {
        clearAllOutputs();

        log('env-output', 'üîç Starting full diagnostic...\n', 'info');

        await checkEnvironment();
        await new Promise(r => setTimeout(r, 1000));

        await testBackendConnection();
        await new Promise(r => setTimeout(r, 1000));

        await testCORSDetailed();
        await new Promise(r => setTimeout(r, 1000));

        await testSignup();
        await new Promise(r => setTimeout(r, 1000));

        await testLogin();
        await new Promise(r => setTimeout(r, 1000));

        if (globalToken) {
            await testProtected();
        }

        // Summary
        clearLog('env-output');
        log('env-output', '\n=== DIAGNOSTIC SUMMARY ===\n', 'info');
        log('env-output', `Environment: ${testResults.environment ? '‚úì' : '‚úó'}`,
            testResults.environment ? 'success' : 'error');
        log('env-output', `Backend: ${testResults.backend ? '‚úì' : '‚úó'}`,
            testResults.backend ? 'success' : 'error');
        log('env-output', `CORS: ${testResults.cors ? '‚úì' : '‚úó'}`,
            testResults.cors ? 'success' : 'error');
        log('env-output', `Auth: ${testResults.auth ? '‚úì' : '‚úó'}`,
            testResults.auth ? 'success' : 'error');

        const allPassed = Object.values(testResults).every(v => v);

        if (allPassed) {
            log('env-output', '\n‚úì ALL TESTS PASSED! Your connection is working.', 'success');
            log('env-output', 'Your frontend should now work with the backend.', 'success');
        } else {
            log('env-output', '\n‚úó Some tests failed. Check the details above.', 'error');
        }
    }

    function clearAllOutputs() {
        ['env-output', 'backend-output', 'cors-output', 'auth-output', 'network-output'].forEach(clearLog);
    }

    // Auto-check on load
    window.onload = () => {
        console.log('Dhvani Debug Tool loaded');
        console.log('Open DevTools Network tab to monitor requests');
    };
</script>
</body>
</html>